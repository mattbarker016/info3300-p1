<html>
<head>
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>

<h1 id="title">Project 1</h1>
<p id="header">Aileen Cai (ac952), Anne Bonalle (aeb295), Matt Barker (mjb485)</p>

<br>

<p>Data is taken from <a href="https://www1.nyc.gov/site/finance/taxes/property-rolling-sales-data.page">NYC.gov</a>. The data represents New York City Sales Data
from January 2018 to December 2018.</p>

<br>

<svg id="manhattan"></svg>

<script>

	//
	// Variables & Constants
	//

	/** 

	Schema

	{
	
		"neighborhood_name" : {

			// Average sale price of property sales
			avg_price: Number

			// Average sq. ft. size of property sales
			avg_sq_ft: Number 

			// Number of property sales used to find average price
			price_count : Number (Int)

			// Number of property sales used to find sq. ft.
			sq_ft_count : Number (Int)

			// The total sum of all sales in filtered data
			tot_price : Number (Int)

			// The total sum of all square footage in filtered data
			tot_sq_ft : Number (Int)
	
		},

		...

	}
	*/
	var property_data = {};

	/** 
	Some properties don't have sale prices. If true, these data
	points will be used to calculate the average square foot amount,
	but won't affect the sale price calculations. If false, these data
	points will be entirely omitted.

	Reccomended: true
	*/
	var countPropertiesWithoutSalePrice = true;

	/**
	Each property sale has n multiple units. When true, data parsing will
	divide sq. ft. and cost among the number of units equally, creating
	n data points based off one initial data point. When false, each property
	sale will be treated as one data point.

	Reccomended: false
	*/
	var useEachUnitAsDataPoint = false;

	//
	// Helper Functions
	//

	function getNumber(d) {
		var n = Number(d.replace(/[^0-9.-]+/g,""));
		return parseInt(n, 10);
	}

	function opt(d) {
		return isNaN(d) ? 0 : d
	}

	/**
		avg - Current existing average
		count - Current existing count of numbers in average
		val - New value to be added to average
		amt - The amount of data points that make up `val`. Default 1.
	*/
	function updateAverage(avg, count, val, amt=1) {

		return ((avg * count) + val) / (count + amt);
	}

	//
	// Main
	//

	d3.csv("manhattan_sales.csv", function(d) {
	  	return {
	    	neighborhood : d["NEIGHBORHOOD"],
	    	total_units : +d["TOTAL UNITS"],
	    	sq_ft : getNumber(d["LAND SQUARE FEET"]),
	    	price : getNumber(d["SALE PRICE"])
	  	};
	}).then(function(data) {

		data.forEach( (property, i) => {

			if (property.neighborhood in property_data) {

				var entry = property_data[property.neighborhood];
				var sq_ft_val = entry.tot_sq_ft;
				var price_val = entry.tot_price;

				var price_count = entry.price_count;
				var sq_ft_count = entry.sq_ft_count;
				var new_amt = useEachUnitAsDataPoint ? property.total_units : 1;

				if (countPropertiesWithoutSalePrice || opt(property.price) != 0) {
					sq_ft_val += property.sq_ft;
					price_val += opt(property.price);
					price_count += opt(property.price) == 0 ? 0 : new_amt;
					sq_ft_count += new_amt;
				}

				property_data[property.neighborhood] = {
					"tot_sq_ft" : sq_ft_val,
					"tot_price" : price_val,
					"price_count" : price_count,
					"sq_ft_count" : sq_ft_count
				};

			} else {

				var price_count = 0;
				var sq_ft_count = 0;
				var new_amt = useEachUnitAsDataPoint ? property.total_units : 1;

				if (countPropertiesWithoutSalePrice || opt(property.price) != 0) {
					price_count = opt(property.price) == 0 ? 0 : new_amt;
					sq_ft_count = new_amt;
				}

				property_data[property.neighborhood] = {
					"tot_sq_ft" : property.sq_ft,
					"tot_price" : opt(property.price),
					"sq_ft_count" : sq_ft_count,
					"price_count" : price_count
				};

			}

		});

		// Calculate averages
		for (var key in property_data) {
			var value = property_data[key];
			var avg_sq_ft = value.tot_sq_ft / value.sq_ft_count;
			var avg_price = value.tot_price / value.price_count;
			property_data[key].avg_sq_ft = avg_sq_ft;
			property_data[key].avg_price = avg_price;
		}

		console.log(property_data);

	});

</script>