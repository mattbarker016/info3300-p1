<html>

	<head>
		<script src="https://d3js.org/d3.v5.min.js"></script>
		<script src="https://d3js.org/topojson.v2.min.js"></script>
	</head>

	<body>

		<h1>Manhattan Property Visualization</h1>
		<h3>INFO 3300: Project 1</h3>
		<p id="header">Aileen Cai (ac952), Anne Bonalle (aeb295), Matt Barker (mjb485)</p>

		<br>

		<h2>Average Square Footage of Properties in Manhattan</h2>
		<svg class="manhattan" id="manhattanSqFt"></svg>
		<svg class="legend" id="legendSqFt"></svg>

		<h2>Average Sale Price of Properties in Manhattan</h2>
		<svg class="manhattan" id="manhattanPrice"></svg>
		<svg class="legend" id="legendPrice"></svg>

		<h2>Dollar per Square Foot of Properties in Manhattan</h2>
		<svg class="manhattan" id="manhattanRatio"></svg>
		<svg class="legend" id="legendRatio"></svg>

		<hr>

		<p>Data is taken from <a href="https://www1.nyc.gov/site/finance/taxes/property-rolling-sales-data.page">NYC.gov</a>. The data represents New York City Sales Data from January 2018 to December 2018.</p>

	</body>

	<script>

		var manhattanData = []

		var SqFt = "SqFt";
		var Price = "Price";
		var Ratio = "Ratio";

		function createManhattanSVG(id, data, features) {

			var svg = d3.select("svg#manhattan" + id);
			
			var path = d3.geoPath()
			.projection(d3.geoConicConformal()
				.parallels([33, 45])
				.rotate([96, -39])
				.fitSize([1000, 1500], features));

			svg.selectAll("path")
				.data(data)
				.enter()
				.append("path")
				.attr("transform","translate("+(-150)+","+(-128)+")")
				.attr("class","region")
				.attr("d", path);

			return svg;

		}

		function addColor(id, min, max, colorArray) {
			let colorScale = d3.scaleQuantile() 
				.domain([min, max])
				.range(colorArray);

			d3.select("#manhattan" + id).selectAll(".region")
				.style("fill", function(d) {
					var key = toTitleCase(d.properties.neighborhood);
					if (key in property_data) {
						switch (id) {
							case SqFt:
								return colorScale(property_data[key].avg_sq_ft)
								break;
							case Price:
								return colorScale(property_data[key].avg_price)
								break;
							default:
								return colorScale(property_data[key].ratio);
						}
					} else {
						return "green";
					}
				});
		}

		function createLegend(id, min, max, colorArray, isMoney) {

			const legend = d3.select("svg#legend" + id);
			const legendWidth = getNumber(legend.style("width"));
			const legendHeight = getNumber(legend.style("height"));
			const barHeight = 40;
			const stepSize = 1;

			const pixelScale = d3.scaleLinear()
				.domain([0, legendWidth-40])
				.range([min, max]);

			const barScale = d3.scaleLinear()
				.domain([min, max])
				.range([0, legendWidth-40]);
			
			const barAxis = d3.axisBottom(barScale)
				.ticks(8, d3.format(isMoney ? "$f" : "d"));

			legend.append("g")
				.attr("class", "color axis")
				.attr("transform","translate("+(20)+","+(barHeight+5)+")")
				.call(barAxis);

			let bar = legend.append("g")
				.attr("transform", "translate("+(20)+","+(0)+")");

			let colorScale = d3.scaleQuantile() 
				.domain([min, max])
				.range(colorArray);

			for (let i=0; i<legendWidth-40; i=i+stepSize) {
				bar.append("rect")
					.attr("x", i)
					.attr("y", 0)
					.attr("width", stepSize)
					.attr("height", barHeight)
					.style("fill", colorScale(pixelScale(i)));
			}

		}

		d3.json("data/nyc-neighborhoods.json").then(function(features) {

			mData = features["features"].filter(function (feature) {
				if (feature == null || feature == undefined) {
					return false;
				}
				return feature.properties.borough == "Manhattan";
			});

			createManhattanSVG(SqFt, mData, features);
			createManhattanSVG(Price, mData, features);
			createManhattanSVG(Ratio, mData, features);

		});

		// Start of Data Parsing

		//
		// Variables & Constants
		//

		var property_data = {};

		/**
 		Each property sale has n multiple units. When true, data parsing will
 		divide sq. ft. and cost among the number of units equally, creating
 		n data points based off one initial data point. When false, each property
 		sale will be treated as one data point.

 		Reccomended: false
 		*/
 		var useEachUnitAsDataPoint = false;

		// Missing Regions

		// Battery Park City (m)
		// Governors Island (m)
		// Liberty Island (m)
		// NoHo (m)
		// Nolita (m)
		// Randall's Island (m)
		// Stuyvesant Town (m)
		// Theater District (m)

		// Mapping of "manhattan-sales.csv" data to "nyc-neighborhoods.json" data
		var neighborhoodDict = {
			"Alphabet City" : "East Village",
			"Clinton" : "Hell's Kitchen",
			"Fashion" : "Midtown",
			"Financial" : "Financial District",
			"Flatiron" : "Flatiron District",
			"Greenwich Village-central" : "Greenwich Village",
			"Greenwich Village-west" : "Greenwich Village",
			"Harlem-central" : "Harlem",
			"Harlem-east" : "East Harlem",
			"Harlem-upper" : "Harlem",
			"Harlem-west" : "Harlem",
			"Javits Center" : "Hell's Kitchen",
			"Manhattan Valley" : "Upper West Side",
			"Midtown Cbd" : "Midtown",
			"Midtown East" : "Midtown",
			"Midtown West" : "Midtown",
			"Soho" : "SoHo",
			"Upper East Side -" : "Upper East Side",
			"Upper West Side -" : "Upper West Side",
			"Washington Heights Lower" : "Washington Heights",
			"Washington Heights Upper" : "Washington Heights"
		};

		//
		// Helper Functions
		//

		function opt(d) {
			return isNaN(d) ? 0 : d
		}

		function getNumber(d) {
			var n = Number(d.replace(/[^0-9.-]+/g,""));
			return opt(parseInt(n, 10));
		}

		function upperFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}
		function lowerCaseWords(string) {
			return string.replace(/\w\S*/g, function (word) {
				return word.charAt(0) + word.slice(1).toLowerCase();
			});
		}

		function toTitleCase(str) {
			return str.replace(/\w\S*/g, function(txt){
				return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
			});
		}

		function removeNonLetters(str) {
			return str.replace(/[^A-Za-z\s-]/g, "");
		}

		/// Map numbers data (n) to map data (m) for neighborhood data sets
		function neighborhoodMapping(input) {
			var neighborhood = removeNonLetters(toTitleCase(input));
			if (neighborhood in neighborhoodDict) {
				return neighborhoodDict[neighborhood];
			} else {
				return neighborhood;
			}
		}

		function calculateData(data) {
			data.forEach( (property, i) => {
				if (property.neighborhood in property_data) {
					var entry = property_data[property.neighborhood];
					var sq_ft_val = entry.tot_sq_ft;
					var price_val = entry.tot_price;

					var price_count = entry.price_count;
					var sq_ft_count = entry.sq_ft_count;
					var new_amt = useEachUnitAsDataPoint ? property.total_units : 1;

					sq_ft_val += property.sq_ft;
					price_val += property.price;
					price_count += property.price > 0 ? new_amt : 0;
					sq_ft_count += property.sq_ft > 0 ? new_amt : 0;

					property_data[property.neighborhood] = {
						"tot_sq_ft" : sq_ft_val,
						"tot_price" : price_val,
						"price_count" : price_count,
						"sq_ft_count" : sq_ft_count
					};

				} else {

					var price_count = 0;
					var sq_ft_count = 0;
					var new_amt = useEachUnitAsDataPoint ? property.total_units : 1;

					price_count = property.price > 0 ? new_amt : 0;
					sq_ft_count = property.sq_ft > 0 ? new_amt : 0;

					property_data[property.neighborhood] = {
						"tot_sq_ft" : property.sq_ft,
						"tot_price" : property.price,
						"sq_ft_count" : sq_ft_count,
						"price_count" : price_count
					};

				}

			});
		}

		var min_price = Number.MAX_SAFE_INTEGER;
		var max_price = 0;
		var min_sq_ft = Number.MAX_SAFE_INTEGER;
		var max_sq_ft = 0;
		var min_ratio = Number.MAX_SAFE_INTEGER;
		var max_ratio = 0;

		function synthesizeData() {
			for (var key in property_data) {

				var value = property_data[key];
				var avg_sq_ft = value.tot_sq_ft / value.sq_ft_count;
				var avg_price = value.tot_price / value.price_count;
				property_data[key].avg_sq_ft = avg_sq_ft;
				property_data[key].avg_price = avg_price;
				property_data[key].ratio = avg_price / avg_sq_ft

				// sq_ft
				if (property_data[key].avg_sq_ft < min_sq_ft) {
					min_sq_ft = property_data[key].avg_sq_ft
				}
				if (property_data[key].avg_sq_ft > max_sq_ft) {
					max_sq_ft = property_data[key].avg_sq_ft
				}

				// price
				if (property_data[key].avg_price < min_price) {
					min_price = property_data[key].avg_price
				}
				if (property_data[key].avg_price > max_price) {
					max_price = property_data[key].avg_price
				}

				// ratio
				if (property_data[key].ratio < min_ratio) {
					min_ratio = property_data[key].ratio
				}
				if (property_data[key].ratio > max_ratio) {
					max_ratio = property_data[key].ratio
				}
			}

		}

		d3.csv("data/manhattan_sales.csv", function(d) {
			var neighborhood = neighborhoodMapping(d["NEIGHBORHOOD"]);
			return {
				neighborhood : neighborhood,
				total_units : +d["TOTAL UNITS"],
				sq_ft : getNumber(d["LAND SQUARE FEET"]),
				price : getNumber(d["SALE PRICE"])
			};
		}).then(function(data) {

			calculateData(data);
			synthesizeData();

			console.log('property_data', property_data);

			let sqFtColorScale = ["#EB7D6B","#CF6D5D","#B35E4F","#984F42","#7E4036","#64322A"];
			addColor(SqFt, min_sq_ft, max_sq_ft, sqFtColorScale);
			createLegend(SqFt, min_sq_ft, max_sq_ft, sqFtColorScale, isMoney=false);

			let priceColorScale = ["#EB7D6B","#CF6D5D","#B35E4F","#984F42","#7E4036","#64322A"];
			addColor(Price, min_price, max_price, priceColorScale);
			createLegend(Price, min_price, max_price, priceColorScale, isMoney=true);

			let ratioColorScale = ["#EB7D6B","#CF6D5D","#B35E4F","#984F42","#7E4036","#64322A"];
			addColor(Ratio, min_ratio, max_ratio, ratioColorScale);
			createLegend(Ratio, min_ratio, max_ratio, ratioColorScale, isMoney=true);

		});


	</script>


	<style>

	.region {
		stroke: black;
		stroke-width: 1px;
		fill: grey;
	}

	.manhattan {
		width: 340px;
		height: 680px;
		background: #F5F5F5;
	}

	.legend {
		width: 400px;
		height: 70px;
		background: #fff;
		margin-top: 30px;
	}

 	hr {
 		margin: 40px;
 	}

 	div	{
 		float: left;
 		margin: 0;
 	}

	</style>

</html>
